{"version":3,"sources":["../../../src/metadata/index.ts","../../../src/readable/content/index.ts"],"names":["getTagType","action","handleMetadata","handlers","formatContent","activity","extractContent","content","metadata","extractSocialPost","formatTitle","title","body","_title","checkTargetExist","target","raw","res"],"mappings":";;;CAQO,SAASA,CAAWC,CAAAA,CAAAA,CAAgB,CAC1C,OAAO,CAAGA,EAAAA,CAAAA,CAAO,GAAG,CAAA,CAAA,EAAIA,CAAO,CAAA,IAAI,CACpC,CAAA,CAEO,SAASC,CAAAA,CAAeD,CAAgBE,CAAAA,CAAAA,CAA6B,CAE3EA,CAAAA,CAASH,CAAWC,CAAAA,CAAM,CAAC,CAAA,GAAIA,CAAO,CAAA,QAAe,EACtD,CCGO,SAASG,CAAAA,CAAcC,EAAoB,CACjD,GAAM,CAACJ,CAAM,CAAII,CAAAA,CAAAA,CAAS,OAAW,EAAA,EACrC,CAAA,OAAOJ,CAASK,CAAAA,CAAAA,CAAeD,CAAUJ,CAAAA,CAAM,CAAI,CAAA,KAAA,CACpD,CAEO,SAASK,CACfD,CAAAA,CAAAA,CACAJ,CAC0B,CAAA,CAC1B,IAAIM,CAAAA,CACJ,OAAAL,CAAAA,CAAeD,CAAQ,CAAA,CACtB,aAAgBO,CAAAA,CAAAA,EAAa,CAC5BD,CAAAA,CAAUE,EAAkBJ,CAAUJ,CAAAA,CAAAA,CAAQO,CAAQ,EACvD,CACA,CAAA,gBAAA,CAAmBA,CAAa,EAAA,CAC/BD,CAAUE,CAAAA,CAAAA,CAAkBJ,CAAUJ,CAAAA,CAAAA,CAAQO,CAAQ,EACvD,CACA,CAAA,aAAA,CAAgBA,CAAa,EAAA,CAC5BD,CAAUE,CAAAA,CAAAA,CAAkBJ,CAAUJ,CAAAA,CAAAA,CAAQO,CAAQ,EACvD,CACA,CAAA,cAAA,CAAiBA,CAAa,EAAA,CAC7BD,CAAUE,CAAAA,CAAAA,CAAkBJ,CAAUJ,CAAAA,CAAAA,CAAQO,CAAQ,EACvD,CAAA,CACA,eAAkBA,CAAAA,CAAAA,EAAa,CAC9BD,CAAAA,CAAUE,CAAkBJ,CAAAA,CAAAA,CAAUJ,CAAQO,CAAAA,CAAQ,EACvD,CAAA,CACA,eAAkBA,CAAAA,CAAAA,EAAa,CAC9BD,CAAAA,CAAUE,CAAkBJ,CAAAA,CAAAA,CAAUJ,CAAQO,CAAAA,CAAQ,EACvD,CACD,CAAC,CAAA,CACMD,CACR,CAKO,SAASG,CAAAA,CAAYC,CAAgBC,CAAAA,CAAAA,CAAe,CAC1D,GAAI,CAACD,CAAO,CAAA,OAAOA,CAEnB,CAAA,IAAME,CAASF,CAAAA,CAAAA,CAAM,UAAW,CAAA,QAAA,CAAK,EAAE,CAAA,CAEvC,OAAOC,CAAAA,EAAM,UAAWC,CAAAA,CAAM,CAAI,CAAA,KAAA,CAAA,CAAYA,CAC/C,CAEO,SAASC,CAAAA,CACfC,CACC,CAAA,CACD,OAAKA,CAAAA,CACD,CAAEA,EAAAA,CAAAA,CAAO,IAAUA,EAAAA,CAAAA,CAAO,KAAWA,EAAAA,CAAAA,CAAO,KAD5B,CAAA,CAAA,CAAA,CAGrB,CAEA,SAASN,CAAAA,CACRJ,CACAJ,CAAAA,CAAAA,CACAO,CACc,CAAA,CACd,IAAMQ,CAAAA,CAAMR,CAAS,CAAA,MAAA,CACfO,CAASC,CAAAA,CAAAA,CACZ,CACA,SAAA,CAAWA,CAAI,CAAA,SAAA,CACf,MAAQA,CAAAA,CAAAA,CAAI,MACZ,CAAA,OAAA,CAASf,CAAO,CAAA,EAAA,CAChB,SAAWe,CAAAA,CAAAA,CAAI,SACf,CAAA,KAAA,CAAON,CAAYM,CAAAA,CAAAA,CAAI,KAAOA,CAAAA,CAAAA,CAAI,IAAI,CAAA,CACtC,KAAMA,CAAI,CAAA,IAAA,CACV,KAAOA,CAAAA,CAAAA,CAAI,KACZ,CAAA,CACC,KAGCD,CAAAA,CAAAA,CAAAA,EAAQ,KAASV,EAAAA,CAAAA,CAAS,OAAS,EAAA,WAAA,EAAkB,GAAA,UAAA,GACxDU,CAAO,CAAA,KAAA,CAAQA,CAAO,CAAA,KAAA,CAAM,KAAM,CAAA,CAAC,CAEpC,CAAA,CAAA,IAAME,CAAM,CAAA,CACX,SAAWT,CAAAA,CAAAA,CAAS,SACpB,CAAA,MAAA,CAAQA,CAAS,CAAA,MAAA,CACjB,OAASP,CAAAA,CAAAA,CAAO,KAChB,SAAWO,CAAAA,CAAAA,CAAS,SACpB,CAAA,KAAA,CAAOE,CAAYF,CAAAA,CAAAA,CAAS,KAAOA,CAAAA,CAAAA,CAAS,IAAI,CAAA,CAChD,IAAMA,CAAAA,CAAAA,CAAS,IACf,CAAA,KAAA,CAAOA,CAAS,CAAA,KAAA,CAChB,OAAQO,CACT,CAAA,CAEA,OAAIE,CAAAA,CAAI,KAASZ,EAAAA,CAAAA,CAAS,OAAS,EAAA,WAAA,EAAkB,GAAA,UAAA,GACpDY,CAAI,CAAA,KAAA,CAAQA,CAAI,CAAA,KAAA,CAAM,KAAM,CAAA,CAAC,GAEvBA,CACR","file":"index.global.js","sourcesContent":["import type { Action } from \"@rss3/api-core\";\n\nimport type { MetadataDoc } from \"./doc.js\";\n\ntype Handlers = {\n\t[K in keyof MetadataDoc]: (metadata: MetadataDoc[K][\"ref\"]) => void;\n};\n\nexport function getTagType(action: Action) {\n\treturn `${action.tag}-${action.type}` as keyof Handlers;\n}\n\nexport function handleMetadata(action: Action, handlers: Partial<Handlers>) {\n\t// biome-ignore lint/suspicious/noExplicitAny: Use of any is necessary here\n\thandlers[getTagType(action)]?.(action.metadata as any);\n}\n\nexport { renderItemActionToHTML } from \"./parser.js\";\n","import type { Action, Activity, SocialPost } from \"@rss3/api-core\";\n\nimport { handleMetadata } from \"../../metadata/index.js\";\n\nexport type Content = {\n\tauthorUrl?: string;\n\thandle?: string;\n\taddress?: string;\n\tprofileId?: string | number | null;\n\ttitle?: string;\n\tbody?: string;\n\tmedia?: SocialPost[\"media\"];\n};\n\nexport type PostContent = Content & {\n\ttarget?: Content;\n};\n\nexport function formatContent(activity: Activity) {\n\tconst [action] = activity.actions ?? [];\n\treturn action ? extractContent(activity, action) : undefined;\n}\n\nexport function extractContent(\n\tactivity: Activity,\n\taction: Action,\n): PostContent | undefined {\n\tlet content: PostContent | undefined;\n\thandleMetadata(action, {\n\t\t\"social-post\": (metadata) => {\n\t\t\tcontent = extractSocialPost(activity, action, metadata);\n\t\t},\n\t\t\"social-comment\": (metadata) => {\n\t\t\tcontent = extractSocialPost(activity, action, metadata);\n\t\t},\n\t\t\"social-mint\": (metadata) => {\n\t\t\tcontent = extractSocialPost(activity, action, metadata);\n\t\t},\n\t\t\"social-share\": (metadata) => {\n\t\t\tcontent = extractSocialPost(activity, action, metadata);\n\t\t},\n\t\t\"social-revise\": (metadata) => {\n\t\t\tcontent = extractSocialPost(activity, action, metadata);\n\t\t},\n\t\t\"social-delete\": (metadata) => {\n\t\t\tcontent = extractSocialPost(activity, action, metadata);\n\t\t},\n\t});\n\treturn content;\n}\n\n/**\n * The special case for lens post, which will use the first sentence of the body as the title\n */\nexport function formatTitle(title?: string, body?: string) {\n\tif (!title) return title;\n\n\tconst _title = title.replaceAll(\"â€¦\", \"\");\n\n\treturn body?.startsWith(_title) ? undefined : _title;\n}\n\nexport function checkTargetExist(\n\ttarget?: Pick<Content, \"body\" | \"media\" | \"title\">,\n) {\n\tif (!target) return false;\n\tif (!!target.body || !!target.media || !!target.title) return true;\n\treturn false;\n}\n\nfunction extractSocialPost(\n\tactivity: Activity,\n\taction: Action,\n\tmetadata: SocialPost,\n): PostContent {\n\tconst raw = metadata.target;\n\tconst target = raw\n\t\t? {\n\t\t\t\tauthorUrl: raw.authorUrl,\n\t\t\t\thandle: raw.handle,\n\t\t\t\taddress: action.to,\n\t\t\t\tprofileId: raw.profileId,\n\t\t\t\ttitle: formatTitle(raw.title, raw.body),\n\t\t\t\tbody: raw.body,\n\t\t\t\tmedia: raw.media,\n\t\t\t}\n\t\t: undefined;\n\t// remove the first media, which is the avatar of the author\n\t// this case only happens in mastodon\n\tif (target?.media && activity.network?.toLowerCase() === \"mastodon\") {\n\t\ttarget.media = target.media.slice(1);\n\t}\n\tconst res = {\n\t\tauthorUrl: metadata.authorUrl,\n\t\thandle: metadata.handle,\n\t\taddress: action.from,\n\t\tprofileId: metadata.profileId,\n\t\ttitle: formatTitle(metadata.title, metadata.body),\n\t\tbody: metadata.body,\n\t\tmedia: metadata.media,\n\t\ttarget: target,\n\t};\n\t// the same as the target\n\tif (res.media && activity.network?.toLowerCase() === \"mastodon\") {\n\t\tres.media = res.media.slice(1);\n\t}\n\treturn res;\n}\n"]}